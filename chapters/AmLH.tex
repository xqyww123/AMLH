\chapter{经典逻辑上的抽象机 $\amlh$}

\section{原理概览} \label{Sec.Overview}

在定理证明器上以经典逻辑预先定义一系列基元函数作为抽象机的基元指令集，
这些基元函数的正确性并非被证明而是作为公理。
基于这些基元函数以$\lambda$演算构建起抽象机。
或是更严谨地说抽象机是在简单类型$\lambda$演算这一个形式系统上
引入一系列作为公理规则的基元函数，
并削除一些功能以将此新的形式系统上的运算限制在基元函数的组合。
抽象机上的程序是这些基元函数的组合。
一些常用的组合可以被保存，作为函数库的形式被之后用户使用。
那么抽象机上的编程就是对基元函数的组合以及这些组合的组合。

这一抽象机是一种形式系统，本文使用记号 $\amlh$ 表示。

基元函数被巧妙的设定，尽可能基层的同时保持良好的数学亲和性。
基元函数即是基元指令，令基元指令集尽可能接近目标编译平台，尽可能的基础，
那么程序的基元指令表达本身就足够接近目标编译平台的汇编表达，
就可以作为编译的中间表达（IR）而输出并由外部程序进行
简单的处理就能编译到目标平台。

那么$\amlh$上的抽象程序到中间表达的编译过程实质就是将抽象程序完全展开到
基元函数表达。这种展开是在定理证明器上进行的等价变换，
编译正确性是有保障的到中间表达级别的。
而外部程序对中间表达到目标平台的编译是固定的且尽可能的简单，
未来可以对这一最后的编译过程进行额外的验证，就可以将编译保障的范围延伸。

这些基元指令虽然简单但可以构造一门编程语言与一系列的理论工具辅助，再
在定理证明器上实现这一系列辅助包括各种半自动的证明策略与分析工具，
最后在外部构建一个完整的接口壳层将一切工具与接口统一起来。
以此提供非常有效的程序开发支持能力。
这么做是可行的，因为传统软件工程就是这样一层层的抽象与辅助而将
用户以编程语言为格式而以源代码为载体承载的抽象思维与执行逻辑一步步翻译转换
最终生成对应的目标平台上机器编码的可执行程序。
即本质上是要模仿传统软件工程的体系而在数理的范畴内再实现一遍。

而在数理的抽象上进行软件工程也意味着大量的改变。

直接使用$\lambda$演算构建抽象机的主要困难有两点。
第一点是系统状态相关的建模，现实的计算机中有大量的系统状态，
而$\lambda$演算本身是无状态的。通用的方案是使用状态机模型而不是直接用$\lambda$演算，
但本工作是从头基于抽象数理设计软件开发故而可以有新的思路。
第二点是线程，状态机模型上线程可以有清晰的概念，而在$\lambda$演算中则并没有。
事实上数理思维中并没有“执行”的概念，就更没有由一系列“执行”按时间线索先后联系在一起构成的
线程。这两点通向相同的解决道路。

数理思维中没有线程，本工作认为，这是数理的一种优势。
$\amlh$不显示地区分线程或是要求用户显示地编写线程与线程操作，相反，既然
现在大量的软件工程实践揭示了并行编程的价值，就在一开始将$\amlh$构造成一个内在并行的系统。
即，$\amlh$上的操作如同数学操作是自然地并行的，串行仅当数值计算上或是逻辑上的依赖时
才会发生。如果操作$A$数值上依赖另一个操作$B$，即$A$的执行需要$B$的结果，
则由$B$到$A$的执行是串行的；
如果操作$A$逻辑上需要等待操作$B$完成后在进行，则需要用户显示地编写状态依赖后可以串行执行；
如果操作$A$和$B$间既没有计算依赖又没有状态依赖，则$A$与$B$是并行执行的。
依赖关系的存否决定并行还是串行，依赖关系的偏序方向决定串行的执行次序。
两个线程是否可以合法地并行，又取决于各自对系统资源的访问。

本工作抽象一切状态为系统资源。
在无状态即没有系统资源的情况下，只有数值依赖；
对于系统资源的访问，可以是数值依赖也可以是状态依赖。
$\amlh$ 是一种并行读取互斥写入（Concurrent Read Exclusive Write, CREW）模型，
即允许多个线程对同一个资源的同时读取却只允许同一时刻一个线程写入资源。
这里的写入与读取不需要是真正的写入或读取，理解为可并行的操作与互斥操作也许更好。
两个线程的并行是否合法即是对资源的访问是否满足CREW。
系统资源与依赖，这两个问题很相关，将在\ref{Sec.hisFlow}节的历史流模型中详细论述。

另外值得注意的，至今为止所说的并行并不要求编译结果也严格地遵守并行。
串行的程序很难并行执行而并行的程序是很容易串行执行的。
$\amlh$上的软件开发从设计到编写再到最后编译出中间表达是始终保持并行的，
但对中间表达最后到目标平台的编译可以根据具体实现自由地选择串行或者部分并行。


%有助于读者直观地感受，尽管其中一些无法绕过的概念与引理尚未给出。
%这些主要是系统状态相关的历史流理论，会在下一节给出论述，而现在将暂时搁置。

\input{./chapters/AmLH/AmLH.def.tex}
\input{./chapters/AmLH/example.tex}
\input{./chapters/AmLH/AmLH.status.tex}


